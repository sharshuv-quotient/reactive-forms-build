import { __extends, __read, __spread } from "tslib";
import { FormGroup as NgFormGroup } from '@angular/forms';
import { isObservable, Subject } from 'rxjs';
import { distinctUntilChanged, tap, take, switchMap } from 'rxjs/operators';
import { controlDisabled$, controlDisabledWhile, controlEnabled$, controlEnabledWhile, controlErrorChanges$, controlStatusChanges$, controlValueChanges$, disableControl, enableControl, hasErrorAndDirty, hasErrorAndTouched, markAllDirty, mergeControlValidators, selectControlValue$, validateControlOn, persistValue$, handleFormArrays } from './control-actions';
import { coerceArray, wrapIntoObservable } from './utils';
import { LocalStorageManager } from './localStorageManager';
var FormGroup = /** @class */ (function (_super) {
    __extends(FormGroup, _super);
    function FormGroup(controls, validatorOrOpts, asyncValidator) {
        var _this = _super.call(this, controls, validatorOrOpts, asyncValidator) || this;
        _this.controls = controls;
        _this.touchChanges = new Subject();
        _this.dirtyChanges = new Subject();
        _this.touch$ = _this.touchChanges.asObservable().pipe(distinctUntilChanged());
        _this.dirty$ = _this.dirtyChanges.asObservable().pipe(distinctUntilChanged());
        _this.value$ = controlValueChanges$(_this);
        _this.disabled$ = controlDisabled$(_this);
        _this.enabled$ = controlEnabled$(_this);
        _this.status$ = controlStatusChanges$(_this);
        _this.errors$ = controlErrorChanges$(_this);
        return _this;
    }
    FormGroup.prototype.select = function (mapFn) {
        return selectControlValue$(this, mapFn);
    };
    FormGroup.prototype.getRawValue = function () {
        return _super.prototype.getRawValue.call(this);
    };
    FormGroup.prototype.get = function (path) {
        return _super.prototype.get.call(this, path);
    };
    FormGroup.prototype.getControl = function () {
        var names = [];
        for (var _i = 0; _i < arguments.length; _i++) {
            names[_i] = arguments[_i];
        }
        return this.get(names);
    };
    FormGroup.prototype.addControl = function (name, control) {
        _super.prototype.addControl.call(this, name, control);
    };
    FormGroup.prototype.removeControl = function (name) {
        _super.prototype.removeControl.call(this, name);
    };
    FormGroup.prototype.contains = function (controlName) {
        return _super.prototype.contains.call(this, controlName);
    };
    FormGroup.prototype.setControl = function (name, control) {
        _super.prototype.setControl.call(this, name, control);
    };
    FormGroup.prototype.setValue = function (valueOrObservable, options) {
        var _this = this;
        if (isObservable(valueOrObservable)) {
            return valueOrObservable.subscribe(function (value) { return _super.prototype.setValue.call(_this, value, options); });
        }
        _super.prototype.setValue.call(this, valueOrObservable, options);
    };
    FormGroup.prototype.patchValue = function (valueOrObservable, options) {
        var _this = this;
        if (isObservable(valueOrObservable)) {
            return valueOrObservable.subscribe(function (value) { return _super.prototype.patchValue.call(_this, value, options); });
        }
        _super.prototype.patchValue.call(this, valueOrObservable, options);
    };
    FormGroup.prototype.disabledWhile = function (observable, options) {
        return controlDisabledWhile(this, observable, options);
    };
    FormGroup.prototype.enabledWhile = function (observable, options) {
        return controlEnabledWhile(this, observable, options);
    };
    FormGroup.prototype.mergeValidators = function (validators) {
        mergeControlValidators(this, validators);
    };
    FormGroup.prototype.mergeAsyncValidators = function (validators) {
        this.setAsyncValidators(__spread([this.asyncValidator], coerceArray(validators)));
        this.updateValueAndValidity();
    };
    FormGroup.prototype.markAsTouched = function (opts) {
        _super.prototype.markAsTouched.call(this, opts);
        this.touchChanges.next(true);
    };
    FormGroup.prototype.markAsUntouched = function (opts) {
        _super.prototype.markAsUntouched.call(this, opts);
        this.touchChanges.next(false);
    };
    FormGroup.prototype.markAsPristine = function (opts) {
        _super.prototype.markAsPristine.call(this, opts);
        this.dirtyChanges.next(false);
    };
    FormGroup.prototype.markAsDirty = function (opts) {
        _super.prototype.markAsDirty.call(this, opts);
        this.dirtyChanges.next(true);
    };
    FormGroup.prototype.markAllAsDirty = function () {
        markAllDirty(this);
    };
    FormGroup.prototype.reset = function (formState, options) {
        _super.prototype.reset.call(this, formState, options);
    };
    FormGroup.prototype.setValidators = function (newValidator) {
        _super.prototype.setValidators.call(this, newValidator);
        _super.prototype.updateValueAndValidity.call(this);
    };
    FormGroup.prototype.setAsyncValidators = function (newValidator) {
        _super.prototype.setAsyncValidators.call(this, newValidator);
        _super.prototype.updateValueAndValidity.call(this);
    };
    FormGroup.prototype.validateOn = function (observableValidation) {
        return validateControlOn(this, observableValidation);
    };
    FormGroup.prototype.hasError = function (errorCode, path) {
        return _super.prototype.hasError.call(this, errorCode, path);
    };
    FormGroup.prototype.setErrors = function (errors, opts) {
        if (opts === void 0) { opts = {}; }
        return _super.prototype.setErrors.call(this, errors, opts);
    };
    FormGroup.prototype.getError = function (errorCode, path) {
        return _super.prototype.getError.call(this, errorCode, path);
    };
    FormGroup.prototype.hasErrorAndTouched = function (error) {
        var path = [];
        for (var _i = 1; _i < arguments.length; _i++) {
            path[_i - 1] = arguments[_i];
        }
        return hasErrorAndTouched.apply(void 0, __spread([this, error], path));
    };
    FormGroup.prototype.hasErrorAndDirty = function (error) {
        var path = [];
        for (var _i = 1; _i < arguments.length; _i++) {
            path[_i - 1] = arguments[_i];
        }
        return hasErrorAndDirty.apply(void 0, __spread([this, error], path));
    };
    FormGroup.prototype.setEnable = function (enable, opts) {
        if (enable === void 0) { enable = true; }
        enableControl(this, enable, opts);
    };
    FormGroup.prototype.setDisable = function (disable, opts) {
        if (disable === void 0) { disable = true; }
        disableControl(this, disable, opts);
    };
    FormGroup.prototype.persist = function (key, _a) {
        var _this = this;
        var debounceTime = _a.debounceTime, manager = _a.manager, arrControlFactory = _a.arrControlFactory;
        var persistManager = manager || new LocalStorageManager();
        return this.restore(key, persistManager, arrControlFactory).pipe(switchMap(function () {
            return persistValue$(_this, key, {
                debounceTime: debounceTime || 250,
                manager: persistManager
            });
        }));
    };
    FormGroup.prototype.restore = function (key, manager, arrControlFactory) {
        var _this = this;
        return wrapIntoObservable(manager.getValue(key)).pipe(take(1), tap(function (value) {
            if (!value)
                return;
            handleFormArrays(_this, value, arrControlFactory);
            _this.patchValue(value, { emitEvent: false });
        }));
    };
    return FormGroup;
}(NgFormGroup));
export { FormGroup };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZm9ybUdyb3VwLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQG5nbmVhdC9yZWFjdGl2ZS1mb3Jtcy8iLCJzb3VyY2VzIjpbImxpYi9mb3JtR3JvdXAudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxTQUFTLElBQUksV0FBVyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDMUQsT0FBTyxFQUFFLFlBQVksRUFBYyxPQUFPLEVBQWdCLE1BQU0sTUFBTSxDQUFDO0FBQ3ZFLE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzVFLE9BQU8sRUFDTCxnQkFBZ0IsRUFDaEIsb0JBQW9CLEVBQ3BCLGVBQWUsRUFDZixtQkFBbUIsRUFDbkIsb0JBQW9CLEVBQ3BCLHFCQUFxQixFQUNyQixvQkFBb0IsRUFDcEIsY0FBYyxFQUNkLGFBQWEsRUFDYixnQkFBZ0IsRUFDaEIsa0JBQWtCLEVBQ2xCLFlBQVksRUFDWixzQkFBc0IsRUFDdEIsbUJBQW1CLEVBQ25CLGlCQUFpQixFQUNqQixhQUFhLEVBQ2IsZ0JBQWdCLEVBQ2pCLE1BQU0sbUJBQW1CLENBQUM7QUFrQjNCLE9BQU8sRUFBRSxXQUFXLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxTQUFTLENBQUM7QUFFMUQsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFHNUQ7SUFBNEUsNkJBQVc7SUFtQnJGLG1CQUNTLFFBQStCLEVBQ3RDLGVBQWlDLEVBQ2pDLGNBQStCO1FBSGpDLFlBS0Usa0JBQU0sUUFBUSxFQUFFLGVBQWUsRUFBRSxjQUFjLENBQUMsU0FDakQ7UUFMUSxjQUFRLEdBQVIsUUFBUSxDQUF1QjtRQWJoQyxrQkFBWSxHQUFHLElBQUksT0FBTyxFQUFXLENBQUM7UUFDdEMsa0JBQVksR0FBRyxJQUFJLE9BQU8sRUFBVyxDQUFDO1FBRTlDLFlBQU0sR0FBRyxLQUFJLENBQUMsWUFBWSxDQUFD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RCxLQUFJLENBQUMsVUFBVSxDQUFDLEtBQUssRUFBRSxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFDO1FBQy9DLENBQUMsQ0FBQyxDQUNILENBQUM7SUFDSixDQUFDO0lBQ0gsZ0JBQUM7QUFBRCxDQUFDLEFBM1JELENBQTRFLFdBQVcsR0EyUnRGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRm9ybUdyb3VwIGFzIE5nRm9ybUdyb3VwIH0gZnJvbSAnQGFuZ3VsYXIvZm9ybXMnO1xuaW1wb3J0IHsgaXNPYnNlcnZhYmxlLCBPYnNlcnZhYmxlLCBTdWJqZWN0LCBTdWJzY3JpcHRpb24gfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGRpc3RpbmN0VW50aWxDaGFuZ2VkLCB0YXAsIHRha2UsIHN3aXRjaE1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7XG4gIGNvbnRyb2xEaXNhYmxlZCQsXG4gIGNvbnRyb2xEaXNhYmxlZFdoaWxlLFxuICBjb250cm9sRW5hYmxlZCQsXG4gIGNvbnRyb2xFbmFibGVkV2hpbGUsXG4gIGNvbnRyb2xFcnJvckNoYW5nZXMkLFxuICBjb250cm9sU3RhdHVzQ2hhbmdlcyQsXG4gIGNvbnRyb2xWYWx1ZUNoYW5nZXMkLFxuICBkaXNhYmxlQ29udHJvbCxcbiAgZW5hYmxlQ29udHJvbCxcbiAgaGFzRXJyb3JBbmREaXJ0eSxcbiAgaGFzRXJyb3JBbmRUb3VjaGVkLFxuICBtYXJrQWxsRGlydHksXG4gIG1lcmdlQ29udHJvbFZhbGlkYXRvcnMsXG4gIHNlbGVjdENvbnRyb2xWYWx1ZSQsXG4gIHZhbGlkYXRlQ29udHJvbE9uLFxuICBwZXJzaXN0VmFsdWUkLFxuICBoYW5kbGVGb3JtQXJyYXlzXG59IGZyb20gJy4vY29udHJvbC1hY3Rpb25zJztcbmltcG9ydCB7XG4gIEFic3RyYWN0Q29udHJvbCxcbiAgQXN5bmNWYWxpZGF0b3IsXG4gIENvbnRyb2xFdmVudE9wdGlvbnMsXG4gIENvbnRyb2xPcHRpb25zLFxuICBDb250cm9sU3RhdGUsXG4gIEVtaXRFdmVudCxcbiAgRXh0cmFjdFN0cmluZ3MsXG4gIE9iaixcbiAgT25seVNlbGYsXG4gIFZhbGlkYXRvcixcbiAgVmFsaWRhdG9yT3JPcHRzLFxuICBDb250cm9sc1ZhbHVlLFxuICBBYnN0cmFjdENvbnRyb2xzT2YsXG4gIFBlcnNpc3RPcHRpb25zLFxuICBDb250cm9sRmFjdG9yeU1hcFxufSBmcm9tICcuL3R5cGVzJztcbmltcG9ydCB7IGNvZXJjZUFycmF5LCB3cmFwSW50b09ic2VydmFibGUgfSBmcm9tICcuL3V0aWxzJztcbmltcG9ydCB7IEZvcm1BcnJheSB9IGZyb20gJy4vZm9ybUFycmF5JztcbmltcG9ydCB7IExvY2FsU3RvcmFnZU1hbmFnZXIgfSBmcm9tICcuL2xvY2FsU3RvcmFnZU1hbmFnZXInO1xuaW1wb3J0IHsgUGVyc2lzdE1hbmFnZXIgfSBmcm9tICcuL3BlcnNpc3RNYW5hZ2VyJztcblxuZXhwb3J0IGNsYXNzIEZvcm1Hcm91cDxUIGV4dGVuZHMgT2JqID0gYW55LCBFIGV4dGVuZHMgb2JqZWN0ID0gYW55PiBleHRlbmRzIE5nRm9ybUdyb3VwIHtcbiAgcmVhZG9ubHkgdmFsdWU6IENvbnRyb2xzVmFsdWU8VD47XG4gIHJlYWRvbmx5IGVycm9yczogRSB8IG51bGw7XG4gIHJlYWRvbmx5IHZhbHVlQ2hhbmdlczogT2JzZXJ2YWJsZTxDb250cm9sc1ZhbHVlPFQ+PjtcbiAgcmVhZG9ubHkgc3RhdHVzOiBDb250cm9sU3RhdGU7XG4gIHJlYWRvbmx5IHN0YXR1c0NoYW5nZXM6IE9ic2VydmFibGU8Q29udHJvbFN0YXRlPjtcblxuICBwcml2YXRlIHRvdWNoQ2hhbmdlcyA9IG5ldyBTdWJqZWN0PGJvb2xlYW4+KCk7XG4gIHByaXZhdGUgZGlydHlDaGFuZ2VzID0gbmV3IFN1YmplY3Q8Ym9vbGVhbj4oKTtcblxuICB0b3VjaCQgPSB0aGlzLnRvdWNoQ2hhbmdlcy5hc09ic2VydmFibGUoKS5waXBlKGRpc3RpbmN0VW50aWxDaGFuZ2VkKCkpO1xuICBkaXJ0eSQgPSB0aGlzLmRpcnR5Q2hhbmdlcy5hc09ic2VydmFibGUoKS5waXBlKGRpc3RpbmN0VW50aWxDaGFuZ2VkKCkpO1xuXG4gIHJlYWRvbmx5IHZhbHVlJCA9IGNvbnRyb2xWYWx1ZUNoYW5nZXMkPENvbnRyb2xzVmFsdWU8VD4+KHRoaXMpO1xuICByZWFkb25seSBkaXNhYmxlZCQgPSBjb250cm9sRGlzYWJsZWQkPENvbnRyb2xzVmFsdWU8VD4+KHRoaXMpO1xuICByZWFkb25seSBlbmFibGVkJCA9IGNvbnRyb2xFbmFibGVkJDxDb250cm9sc1ZhbHVlPFQ+Pih0aGlzKTtcbiAgcmVhZG9ubHkgc3RhdHVzJCA9IGNvbnRyb2xTdGF0dXNDaGFuZ2VzJDxDb250cm9sc1ZhbHVlPFQ+Pih0aGlzKTtcbiAgcmVhZG9ubHkgZXJyb3JzJCA9IGNvbnRyb2xFcnJvckNoYW5nZXMkPEU+KHRoaXMpO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHB1YmxpYyBjb250cm9sczogQWJzdHJhY3RDb250cm9sc09mPFQ+LFxuICAgIHZhbGlkYXRvck9yT3B0cz86IFZhbGlkYXRvck9yT3B0cyxcbiAgICBhc3luY1ZhbGlkYXRvcj86IEFzeW5jVmFsaWRhdG9yXG4gICkge1xuICAgIHN1cGVyKGNvbnRyb2xzLCB2YWxpZGF0b3JPck9wdHMsIGFzeW5jVmFsaWRhdG9yKTtcbiAgfVxuXG4gIHNlbGVjdDxSPihtYXBGbjogKHN0YXRlOiBDb250cm9sc1ZhbHVlPFQ+KSA9PiBSKTogT2JzZXJ2YWJsZTxSPiB7XG4gICAgcmV0dXJuIHNlbGVjdENvbnRyb2xWYWx1ZSQodGhpcywgbWFwRm4pO1xuICB9XG5cbiAgZ2V0UmF3VmFsdWUoKTogQ29udHJvbHNWYWx1ZTxUPiB7XG4gICAgcmV0dXJuIHN1cGVyLmdldFJhd1ZhbHVlKCk7XG4gIH1cblxuICBnZXQ8SzEgZXh0ZW5kcyBrZXlvZiBDb250cm9sc1ZhbHVlPFQ+PihwYXRoPzogW0sxXSk6IEFic3RyYWN0Q29udHJvbHNPZjxUPltLMV07XG4gIGdldDxcbiAgICBLMSBleHRlbmRzIGtleW9mIENvbnRyb2xzVmFsdWU8VD4sXG4gICAgSzIgZXh0ZW5kcyBBYnN0cmFjdENvbnRyb2xzT2Y8VD5bSzFdIGV4dGVuZHMgRm9ybUdyb3VwIHwgRm9ybUFycmF5XG4gICAgICA/IGtleW9mIEFic3RyYWN0Q29udHJvbHNPZjxUPltLMV1bJ2NvbnRyb2xzJ11cbiAgICAgIDogbmV2ZXJcbiAgPihcbiAgICBwYXRoPzogW0sxLCBLMl1cbiAgKTogQWJzdHJhY3RDb250cm9sc09mPFQ+W0sxXSBleHRlbmRzIEZvcm1Hcm91cCB8IEZvcm1BcnJheSA/IEFic3RyYWN0Q29udHJvbHNPZjxUPltLMV1bJ2NvbnRyb2xzJ11bSzJdIDogbmV2ZXI7XG4gIGdldDxLMSBleHRlbmRzIGtleW9mIENvbnRyb2xzVmFsdWU8VD4sIEsyIGV4dGVuZHMga2V5b2YgQ29udHJvbHNWYWx1ZTxUPltLMV0+KFxuICAgIHBhdGg/OiBbSzEsIEsyXVxuICApOiBBYnN0cmFjdENvbnRyb2w8Q29udHJvbHNWYWx1ZTxUPltLMV1bSzJdPjtcbiAgZ2V0PFxuICAgIEsxIGV4dGVuZHMga2V5b2YgQ29udHJvbHNWYWx1ZTxUPixcbiAgICBLMiBleHRlbmRzIGtleW9mIENvbnRyb2xzVmFsdWU8VD5bSzFdLFxuICAgIEszIGV4dGVuZHMga2V5b2YgQ29udHJvbHNWYWx1ZTxUPltLMV1bSzJdXG4gID4ocGF0aD86IFtLMSwgSzIsIEszXSk6IEFic3RyYWN0Q29udHJvbDxDb250cm9sc1ZhbHVlPFQ+W0sxXVtLMl1bSzNdPjtcbiAgZ2V0KHBhdGg/OiBBcnJheTxzdHJpbmcgfCBudW1iZXI+IHwgc3RyaW5nKTogQWJzdHJhY3RDb250cm9sO1xuICBnZXQocGF0aDogQXJyYXk8c3RyaW5nIHwgbnVtYmVyPiB8IHN0cmluZykge1xuICAgIHJldHVybiBzdXBlci5nZXQocGF0aCk7XG4gIH1cblxuICBnZXRDb250cm9sPFAxIGV4dGVuZHMga2V5b2YgQ29udHJvbHNWYWx1ZTxUPj4ocGF0aD86IFAxKTogQWJzdHJhY3RDb250cm9sc09mPFQ+W1AxXTtcbiAgZ2V0Q29udHJvbDxcbiAgICBQMSBleHRlbmRzIGtleW9mIENvbnRyb2xzVmFsdWU8VD4sXG4gICAgUDIgZXh0ZW5kcyBBYnN0cmFjdENvbnRyb2xzT2Y8VD5bUDFdIGV4dGVuZHMgRm9ybUdyb3VwIHwgRm9ybUFycmF5XG4gICAgICA/IGtleW9mIEFic3RyYWN0Q29udHJvbHNPZjxUPltQMV1bJ2NvbnRyb2xzJ11cbiAgICAgIDogbmV2ZXJcbiAgPihcbiAgICBwcm9wMTogUDEsXG4gICAgcHJvcDI6IFAyXG4gICk6IEFic3RyYWN0Q29udHJvbHNPZjxUPltQMV0gZXh0ZW5kcyBGb3JtR3JvdXAgfCBGb3JtQXJyYXkgPyBBYnN0cmFjdENvbnRyb2xzT2Y8VD5bUDFdWydjb250cm9scyddW1AyXSA6IG5ldmVyO1xuICBnZXRDb250cm9sPFAxIGV4dGVuZHMga2V5b2YgQ29udHJvbHNWYWx1ZTxUPiwgUDIgZXh0ZW5kcyBrZXlvZiBDb250cm9sc1ZhbHVlPFQ+W1AxXT4oXG4gICAgcHJvcDE6IFAxLFxuICAgIHByb3AyOiBQMlxuICApOiBBYnN0cmFjdENvbnRyb2w8Q29udHJvbHNWYWx1ZTxUPltQMV1bUDJdPjtcbiAgZ2V0Q29udHJvbDxcbiAgICBQMSBleHRlbmRzIGtleW9mIENvbnRyb2xzVmFsdWU8VD4sXG4gICAgUDIgZXh0ZW5kcyBrZXlvZiBDb250cm9sc1ZhbHVlPFQ+W1AxXSxcbiAgICBQMyBleHRlbmRzIGtleW9mIENvbnRyb2xzVmFsdWU8VD5bUDFdW1AyXVxuICA+KHByb3AxOiBQMSwgcHJvcDI6IFAyLCBwcm9wMzogUDMpOiBBYnN0cmFjdENvbnRyb2w8Q29udHJvbHNWYWx1ZTxUPltQMV1bUDJdW1AzXT47XG4gIGdldENvbnRyb2wocGF0aD86IHN0cmluZyk6IEFic3RyYWN0Q29udHJvbDtcbiAgZ2V0Q29udHJvbCguLi5uYW1lczogQXJyYXk8c3RyaW5nIHwgbnVtYmVyPik6IEFic3RyYWN0Q29udHJvbDxhbnk+IHtcbiAgICByZXR1cm4gdGhpcy5nZXQobmFtZXMpO1xuICB9XG5cbiAgYWRkQ29udHJvbDxLIGV4dGVuZHMgRXh0cmFjdFN0cmluZ3M8VD4+KG5hbWU6IEssIGNvbnRyb2w6IEFic3RyYWN0Q29udHJvbHNPZjxUPltLXSk6IHZvaWQge1xuICAgIHN1cGVyLmFkZENvbnRyb2wobmFtZSwgY29udHJvbCk7XG4gIH1cblxuICByZW1vdmVDb250cm9sKG5hbWU6IEV4dHJhY3RTdHJpbmdzPFQ+KTogdm9pZCB7XG4gICAgc3VwZXIucmVtb3ZlQ29udHJvbChuYW1lKTtcbiAgfVxuXG4gIGNvbnRhaW5zKGNvbnRyb2xOYW1lOiBFeHRyYWN0U3RyaW5nczxUPik6IGJvb2xlYW4ge1xuICAgIHJldHVybiBzdXBlci5jb250YWlucyhjb250cm9sTmFtZSk7XG4gIH1cblxuICBzZXRDb250cm9sPEsgZXh0ZW5kcyBFeHRyYWN0U3RyaW5nczxUPj4obmFtZTogSywgY29udHJvbDogQWJzdHJhY3RDb250cm9sc09mPFQ+W0tdKTogdm9pZCB7XG4gICAgc3VwZXIuc2V0Q29udHJvbChuYW1lLCBjb250cm9sKTtcbiAgfVxuXG4gIHNldFZhbHVlKHZhbHVlT3JPYnNlcnZhYmxlOiBPYnNlcnZhYmxlPENvbnRyb2xzVmFsdWU8VD4+LCBvcHRpb25zPzogQ29udHJvbEV2ZW50T3B0aW9ucyk6IFN1YnNjcmlwdGlvbjtcbiAgc2V0VmFsdWUodmFsdWVPck9ic2VydmFibGU6IENvbnRyb2xzVmFsdWU8VD4sIG9wdGlvbnM/OiBDb250cm9sRXZlbnRPcHRpb25zKTogdm9pZDtcbiAgc2V0VmFsdWUodmFsdWVPck9ic2VydmFibGU6IGFueSwgb3B0aW9ucz86IENvbnRyb2xFdmVudE9wdGlvbnMpOiBhbnkge1xuICAgIGlmIChpc09ic2VydmFibGUodmFsdWVPck9ic2VydmFibGUpKSB7XG4gICAgICByZXR1cm4gdmFsdWVPck9ic2VydmFibGUuc3Vic2NyaWJlKHZhbHVlID0+IHN1cGVyLnNldFZhbHVlKHZhbHVlLCBvcHRpb25zKSk7XG4gICAgfVxuXG4gICAgc3VwZXIuc2V0VmFsdWUodmFsdWVPck9ic2VydmFibGUsIG9wdGlvbnMpO1xuICB9XG5cbiAgcGF0Y2hWYWx1ZSh2YWx1ZU9yT2JzZXJ2YWJsZTogT2JzZXJ2YWJsZTxQYXJ0aWFsPENvbnRyb2xzVmFsdWU8VD4+Piwgb3B0aW9ucz86IENvbnRyb2xFdmVudE9wdGlvbnMpOiBTdWJzY3JpcHRpb247XG4gIHBhdGNoVmFsdWUodmFsdWVPck9ic2VydmFibGU6IFBhcnRpYWw8Q29udHJvbHNWYWx1ZTxUPj4sIG9wdGlvbnM/OiBDb250cm9sRXZlbnRPcHRpb25zKTogdm9pZDtcbiAgcGF0Y2hWYWx1ZSh2YWx1ZU9yT2JzZXJ2YWJsZTogYW55LCBvcHRpb25zPzogQ29udHJvbEV2ZW50T3B0aW9ucyk6IFN1YnNjcmlwdGlvbiB8IHZvaWQge1xuICAgIGlmIChpc09ic2VydmFibGUodmFsdWVPck9ic2VydmFibGUpKSB7XG4gICAgICByZXR1cm4gdmFsdWVPck9ic2VydmFibGUuc3Vic2NyaWJlKHZhbHVlID0+IHN1cGVyLnBhdGNoVmFsdWUodmFsdWUsIG9wdGlvbnMpKTtcbiAgICB9XG5cbiAgICBzdXBlci5wYXRjaFZhbHVlKHZhbHVlT3JPYnNlcnZhYmxlLCBvcHRpb25zKTtcbiAgfVxuXG4gIGRpc2FibGVkV2hpbGUob2JzZXJ2YWJsZTogT2JzZXJ2YWJsZTxib29sZWFuPiwgb3B0aW9ucz86IENvbnRyb2xPcHRpb25zKSB7XG4gICAgcmV0dXJuIGNvbnRyb2xEaXNhYmxlZFdoaWxlKHRoaXMsIG9ic2VydmFibGUsIG9wdGlvbnMpO1xuICB9XG5cbiAgZW5hYmxlZFdoaWxlKG9ic2VydmFibGU6IE9ic2VydmFibGU8Ym9vbGVhbj4sIG9wdGlvbnM/OiBDb250cm9sT3B0aW9ucykge1xuICAgIHJldHVybiBjb250cm9sRW5hYmxlZFdoaWxlKHRoaXMsIG9ic2VydmFibGUsIG9wdGlvbnMpO1xuICB9XG5cbiAgbWVyZ2VWYWxpZGF0b3JzKHZhbGlkYXRvcnM6IFZhbGlkYXRvcikge1xuICAgIG1lcmdlQ29udHJvbFZhbGlkYXRvcnModGhpcywgdmFsaWRhdG9ycyk7XG4gIH1cblxuICBtZXJnZUFzeW5jVmFsaWRhdG9ycyh2YWxpZGF0b3JzOiBBc3luY1ZhbGlkYXRvcikge1xuICAgIHRoaXMuc2V0QXN5bmNWYWxpZGF0b3JzKFt0aGlzLmFzeW5jVmFsaWRhdG9yLCAuLi5jb2VyY2VBcnJheSh2YWxpZGF0b3JzKV0pO1xuICAgIHRoaXMudXBkYXRlVmFsdWVBbmRWYWxpZGl0eSgpO1xuICB9XG5cbiAgbWFya0FzVG91Y2hlZChvcHRzPzogT25seVNlbGYpOiB2b2lkIHtcbiAgICBzdXBlci5tYXJrQXNUb3VjaGVkKG9wdHMpO1xuICAgIHRoaXMudG91Y2hDaGFuZ2VzLm5leHQodHJ1ZSk7XG4gIH1cblxuICBtYXJrQXNVbnRvdWNoZWQob3B0cz86IE9ubHlTZWxmKTogdm9pZCB7XG4gICAgc3VwZXIubWFya0FzVW50b3VjaGVkKG9wdHMpO1xuICAgIHRoaXMudG91Y2hDaGFuZ2VzLm5leHQoZmFsc2UpO1xuICB9XG5cbiAgbWFya0FzUHJpc3RpbmUob3B0cz86IE9ubHlTZWxmKTogdm9pZCB7XG4gICAgc3VwZXIubWFya0FzUHJpc3RpbmUob3B0cyk7XG4gICAgdGhpcy5kaXJ0eUNoYW5nZXMubmV4dChmYWxzZSk7XG4gIH1cblxuICBtYXJrQXNEaXJ0eShvcHRzPzogT25seVNlbGYpOiB2b2lkIHtcbiAgICBzdXBlci5tYXJrQXNEaXJ0eShvcHRzKTtcbiAgICB0aGlzLmRpcnR5Q2hhbmdlcy5uZXh0KHRydWUpO1xuICB9XG5cbiAgbWFya0FsbEFzRGlydHkoKTogdm9pZCB7XG4gICAgbWFya0FsbERpcnR5KHRoaXMpO1xuICB9XG5cbiAgcmVzZXQoZm9ybVN0YXRlPzogUGFydGlhbDxDb250cm9sc1ZhbHVlPFQ+Piwgb3B0aW9ucz86IENvbnRyb2xFdmVudE9wdGlvbnMpOiB2b2lkIHtcbiAgICBzdXBlci5yZXNldChmb3JtU3RhdGUsIG9wdGlvbnMpO1xuICB9XG5cbiAgc2V0VmFsaWRhdG9ycyhuZXdWYWxpZGF0b3I6IFZhbGlkYXRvcik6IHZvaWQge1xuICAgIHN1cGVyLnNldFZhbGlkYXRvcnMobmV3VmFsaWRhdG9yKTtcbiAgICBzdXBlci51cGRhdGVWYWx1ZUFuZFZhbGlkaXR5KCk7XG4gIH1cblxuICBzZXRBc3luY1ZhbGlkYXRvcnMobmV3VmFsaWRhdG9yOiBBc3luY1ZhbGlkYXRvcik6IHZvaWQge1xuICAgIHN1cGVyLnNldEFzeW5jVmFsaWRhdG9ycyhuZXdWYWxpZGF0b3IpO1xuICAgIHN1cGVyLnVwZGF0ZVZhbHVlQW5kVmFsaWRpdHkoKTtcbiAgfVxuXG4gIHZhbGlkYXRlT24ob2JzZXJ2YWJsZVZhbGlkYXRpb246IE9ic2VydmFibGU8bnVsbCB8IG9iamVjdD4pIHtcbiAgICByZXR1cm4gdmFsaWRhdGVDb250cm9sT24odGhpcywgb2JzZXJ2YWJsZVZhbGlkYXRpb24pO1xuICB9XG5cbiAgaGFzRXJyb3I8SzEgZXh0ZW5kcyBrZXlvZiBDb250cm9sc1ZhbHVlPFQ+PihlcnJvckNvZGU6IEV4dHJhY3RTdHJpbmdzPEU+LCBwYXRoPzogW0sxXSk6IGJvb2xlYW47XG4gIGhhc0Vycm9yPEsxIGV4dGVuZHMga2V5b2YgQ29udHJvbHNWYWx1ZTxUPiwgSzIgZXh0ZW5kcyBrZXlvZiBDb250cm9sc1ZhbHVlPFQ+W0sxXT4oXG4gICAgZXJyb3JDb2RlOiBFeHRyYWN0U3RyaW5nczxFPixcbiAgICBwYXRoPzogW0sxLCBLMl1cbiAgKTogYm9vbGVhbjtcbiAgaGFzRXJyb3I8XG4gICAgSzEgZXh0ZW5kcyBrZXlvZiBDb250cm9sc1ZhbHVlPFQ+LFxuICAgIEsyIGV4dGVuZHMga2V5b2YgQ29udHJvbHNWYWx1ZTxUPltLMV0sXG4gICAgSzMgZXh0ZW5kcyBrZXlvZiBDb250cm9sc1ZhbHVlPFQ+W0sxXVtLMl1cbiAgPihlcnJvckNvZGU6IEV4dHJhY3RTdHJpbmdzPEU+LCBwYXRoPzogW0sxLCBLMiwgSzNdKTogYm9vbGVhbjtcbiAgaGFzRXJyb3IoZXJyb3JDb2RlOiBFeHRyYWN0U3RyaW5nczxFPiwgcGF0aD86IHN0cmluZyk6IGJvb2xlYW47XG4gIGhhc0Vycm9yKGVycm9yQ29kZTogRXh0cmFjdFN0cmluZ3M8RT4sIHBhdGg/OiBhbnkpOiBib29sZWFuIHtcbiAgICByZXR1cm4gc3VwZXIuaGFzRXJyb3IoZXJyb3JDb2RlLCBwYXRoKTtcbiAgfVxuXG4gIHNldEVycm9ycyhlcnJvcnM6IFBhcnRpYWw8RT4gfCBudWxsLCBvcHRzOiBFbWl0RXZlbnQgPSB7fSkge1xuICAgIHJldHVybiBzdXBlci5zZXRFcnJvcnMoZXJyb3JzLCBvcHRzKTtcbiAgfVxuXG4gIGdldEVycm9yPEsgZXh0ZW5kcyBrZXlvZiBFLCBLMSBleHRlbmRzIGtleW9mIENvbnRyb2xzVmFsdWU8VD4+KGVycm9yQ29kZTogSywgcGF0aD86IFtLMV0pOiBFW0tdIHwgbnVsbDtcbiAgZ2V0RXJyb3I8SyBleHRlbmRzIGtleW9mIEUsIEsxIGV4dGVuZHMga2V5b2YgQ29udHJvbHNWYWx1ZTxUPiwgSzIgZXh0ZW5kcyBrZXlvZiBDb250cm9sc1ZhbHVlPFQ+W0sxXT4oXG4gICAgZXJyb3JDb2RlOiBLLFxuICAgIHBhdGg/OiBbSzEsIEsyXVxuICApOiBFW0tdIHwgbnVsbDtcbiAgZ2V0RXJyb3I8XG4gICAgSyBleHRlbmRzIGtleW9mIEUsXG4gICAgSzEgZXh0ZW5kcyBrZXlvZiBDb250cm9sc1ZhbHVlPFQ+LFxuICAgIEsyIGV4dGVuZHMga2V5b2YgQ29udHJvbHNWYWx1ZTxUPltLMV0sXG4gICAgSzMgZXh0ZW5kcyBrZXlvZiBDb250cm9sc1ZhbHVlPFQ+W0sxXVtLMl1cbiAgPihlcnJvckNvZGU6IEssIHBhdGg/OiBbSzEsIEsyLCBLM10pOiBFW0tdIHwgbnVsbDtcbiAgZ2V0RXJyb3I8SyBleHRlbmRzIGtleW9mIEU+KGVycm9yQ29kZTogSywgcGF0aD86IHN0cmluZyk6IEVbS10gfCBudWxsO1xuICBnZXRFcnJvcjxLIGV4dGVuZHMga2V5b2YgRT4oZXJyb3JDb2RlOiBLLCBwYXRoPzogYW55KTogRVtLXSB8IG51bGwge1xuICAgIHJldHVybiBzdXBlci5nZXRFcnJvcihlcnJvckNvZGUgYXMgYW55LCBwYXRoKSBhcyBFW0tdIHwgbnVsbDtcbiAgfVxuXG4gIGhhc0Vycm9yQW5kVG91Y2hlZDxQMSBleHRlbmRzIGtleW9mIENvbnRyb2xzVmFsdWU8VD4+KGVycm9yOiBFeHRyYWN0U3RyaW5nczxFPiwgcHJvcDE/OiBQMSk6IGJvb2xlYW47XG4gIGhhc0Vycm9yQW5kVG91Y2hlZDxQMSBleHRlbmRzIGtleW9mIENvbnRyb2xzVmFsdWU8VD4sIFAyIGV4dGVuZHMga2V5b2YgQ29udHJvbHNWYWx1ZTxUPltQMV0+KFxuICAgIGVycm9yOiBFeHRyYWN0U3RyaW5nczxFPixcbiAgICBwcm9wMT86IFAxLFxuICAgIHByb3AyPzogUDJcbiAgKTogYm9vbGVhbjtcbiAgaGFzRXJyb3JBbmRUb3VjaGVkPFxuICAgIFAxIGV4dGVuZHMga2V5b2YgQ29udHJvbHNWYWx1ZTxUPixcbiAgICBQMiBleHRlbmRzIGtleW9mIENvbnRyb2xzVmFsdWU8VD5bUDFdLFxuICAgIFAzIGV4dGVuZHMga2V5b2YgQ29udHJvbHNWYWx1ZTxUPltQMV1bUDJdXG4gID4oZXJyb3I6IEV4dHJhY3RTdHJpbmdzPEU+LCBwcm9wMT86IFAxLCBwcm9wMj86IFAyLCBwcm9wMz86IFAzKTogYm9vbGVhbjtcbiAgaGFzRXJyb3JBbmRUb3VjaGVkPFxuICAgIFAxIGV4dGVuZHMga2V5b2YgQ29udHJvbHNWYWx1ZTxUPixcbiAgICBQMiBleHRlbmRzIGtleW9mIENvbnRyb2xzVmFsdWU8VD5bUDFdLFxuICAgIFAzIGV4dGVuZHMga2V5b2YgQ29udHJvbHNWYWx1ZTxUPltQMV1bUDJdLFxuICAgIFA0IGV4dGVuZHMga2V5b2YgQ29udHJvbHNWYWx1ZTxUPltQMV1bUDJdW1AzXVxuICA+KGVycm9yOiBFeHRyYWN0U3RyaW5nczxFPiwgcHJvcDE/OiBQMSwgcHJvcDI/OiBQMiwgcHJvcDM/OiBQMywgcHJvcDQ/OiBQNCk6IGJvb2xlYW47XG4gIGhhc0Vycm9yQW5kVG91Y2hlZChlcnJvcjogYW55LCAuLi5wYXRoOiBhbnkpOiBib29sZWFuIHtcbiAgICByZXR1cm4gaGFzRXJyb3JBbmRUb3VjaGVkKHRoaXMsIGVycm9yLCAuLi5wYXRoKTtcbiAgfVxuXG4gIGhhc0Vycm9yQW5kRGlydHk8UDEgZXh0ZW5kcyBrZXlvZiBDb250cm9sc1ZhbHVlPFQ+PihlcnJvcjogRXh0cmFjdFN0cmluZ3M8RT4sIHByb3AxPzogUDEpOiBib29sZWFuO1xuICBoYXNFcnJvckFuZERpcnR5PFAxIGV4dGVuZHMga2V5b2YgQ29udHJvbHNWYWx1ZTxUPiwgUDIgZXh0ZW5kcyBrZXlvZiBDb250cm9sc1ZhbHVlPFQ+W1AxXT4oXG4gICAgZXJyb3I6IEV4dHJhY3RTdHJpbmdzPEU+LFxuICAgIHByb3AxPzogUDEsXG4gICAgcHJvcDI/OiBQMlxuICApOiBib29sZWFuO1xuICBoYXNFcnJvckFuZERpcnR5PFxuICAgIFAxIGV4dGVuZHMga2V5b2YgQ29udHJvbHNWYWx1ZTxUPixcbiAgICBQMiBleHRlbmRzIGtleW9mIENvbnRyb2xzVmFsdWU8VD5bUDFdLFxuICAgIFAzIGV4dGVuZHMga2V5b2YgQ29udHJvbHNWYWx1ZTxUPltQMV1bUDJdXG4gID4oZXJyb3I6IEV4dHJhY3RTdHJpbmdzPEU+LCBwcm9wMT86IFAxLCBwcm9wMj86IFAyLCBwcm9wMz86IFAzKTogYm9vbGVhbjtcbiAgaGFzRXJyb3JBbmREaXJ0eTxcbiAgICBQMSBleHRlbmRzIGtleW9mIENvbnRyb2xzVmFsdWU8VD4sXG4gICAgUDIgZXh0ZW5kcyBrZXlvZiBDb250cm9sc1ZhbHVlPFQ+W1AxXSxcbiAgICBQMyBleHRlbmRzIGtleW9mIENvbnRyb2xzVmFsdWU8VD5bUDFdW1AyXSxcbiAgICBQNCBleHRlbmRzIGtleW9mIENvbnRyb2xzVmFsdWU8VD5bUDFdW1AyXVtQM11cbiAgPihlcnJvcjogRXh0cmFjdFN0cmluZ3M8RT4sIHByb3AxPzogUDEsIHByb3AyPzogUDIsIHByb3AzPzogUDMsIHByb3A0PzogUDQpOiBib29sZWFuO1xuICBoYXNFcnJvckFuZERpcnR5KGVycm9yOiBhbnksIC4uLnBhdGg6IGFueSk6IGJvb2xlYW4ge1xuICAgIHJldHVybiBoYXNFcnJvckFuZERpcnR5KHRoaXMsIGVycm9yLCAuLi5wYXRoKTtcbiAgfVxuXG4gIHNldEVuYWJsZShlbmFibGUgPSB0cnVlLCBvcHRzPzogQ29udHJvbEV2ZW50T3B0aW9ucykge1xuICAgIGVuYWJsZUNvbnRyb2wodGhpcywgZW5hYmxlLCBvcHRzKTtcbiAgfVxuXG4gIHNldERpc2FibGUoZGlzYWJsZSA9IHRydWUsIG9wdHM/OiBDb250cm9sRXZlbnRPcHRpb25zKSB7XG4gICAgZGlzYWJsZUNvbnRyb2wodGhpcywgZGlzYWJsZSwgb3B0cyk7XG4gIH1cblxuICBwZXJzaXN0KGtleTogc3RyaW5nLCB7IGRlYm91bmNlVGltZSwgbWFuYWdlciwgYXJyQ29udHJvbEZhY3RvcnkgfTogUGVyc2lzdE9wdGlvbnM8VD4pOiBPYnNlcnZhYmxlPFQ+IHtcbiAgICBjb25zdCBwZXJzaXN0TWFuYWdlciA9IG1hbmFnZXIgfHwgbmV3IExvY2FsU3RvcmFnZU1hbmFnZXIoKTtcbiAgICByZXR1cm4gdGhpcy5yZXN0b3JlKGtleSwgcGVyc2lzdE1hbmFnZXIsIGFyckNvbnRyb2xGYWN0b3J5KS5waXBlKFxuICAgICAgc3dpdGNoTWFwKCgpID0+XG4gICAgICAgIHBlcnNpc3RWYWx1ZSQodGhpcywga2V5LCB7XG4gICAgICAgICAgZGVib3VuY2VUaW1lOiBkZWJvdW5jZVRpbWUgfHwgMjUwLFxuICAgICAgICAgIG1hbmFnZXI6IHBlcnNpc3RNYW5hZ2VyXG4gICAgICAgIH0pXG4gICAgICApXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgcmVzdG9yZShrZXk6IHN0cmluZywgbWFuYWdlcjogUGVyc2lzdE1hbmFnZXI8VD4sIGFyckNvbnRyb2xGYWN0b3J5OiBDb250cm9sRmFjdG9yeU1hcDxUPik6IE9ic2VydmFibGU8VD4ge1xuICAgIHJldHVybiB3cmFwSW50b09ic2VydmFibGU8VD4obWFuYWdlci5nZXRWYWx1ZShrZXkpKS5waXBlKFxuICAgICAgdGFrZSgxKSxcbiAgICAgIHRhcCh2YWx1ZSA9PiB7XG4gICAgICAgIGlmICghdmFsdWUpIHJldHVybjtcbiAgICAgICAgaGFuZGxlRm9ybUFycmF5cyh0aGlzLCB2YWx1ZSwgYXJyQ29udHJvbEZhY3RvcnkpO1xuICAgICAgICB0aGlzLnBhdGNoVmFsdWUodmFsdWUsIHsgZW1pdEV2ZW50OiBmYWxzZSB9KTtcbiAgICAgIH0pXG4gICAgKTtcbiAgfVxufVxuIl19